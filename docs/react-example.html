<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns#">
<head>
    <meta charset='utf-8'>
    <title>Flow | A Flux & React demo</title>
    <link rel='stylesheet' href='/static/flow.css' type='text/css'/>
    <link rel='stylesheet' href='/static/syntax.css' type='text/css'/>
    <link rel="stylesheet" href='/static/pygments.css' type='text/css'/>
    <link rel='shortcut icon' href='/static/favicon.png'>
    <meta name='viewport' content='width=480'>
    <meta property="og:title" content="A Flux & React demo" />
    <meta property="og:site_name" content="flowtype">
    <meta property='og:description' content='Flow is a static type checker for
    JavaScript.'>
    <meta property='og:image' content='http://flowtype.org/static/flow-og-image.png'>
    <meta property='og:url' content="http://flowtype.org/docs/react-example.html">
    
    <meta property='og:type' content='website'>
    
    <script type="text/javascript" src="//use.typekit.net/vqa1hcx.js"></script>
    <script type="text/javascript">{'try{Typekit.load();}catch(e){}'}</script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-49208336-4', 'auto');
      ga('send', 'pageview');
    </script>
    <link rel="alternate" type="application/rss+xml" title="Flow" href="http://flowtype.org/blog/feed.xml">
</head>
<body>

<header class='topbar'><nav class='width'>
<a href='/'>
  <img src="/static/flow-logo.png" class="logo">
</a>
    <ul>
      <li><a href="/docs/getting-started.html#_"
           class="active" >
          Docs
      </a></li>
      <li><a href="/docs/about-flow.html#_"
          >
          About
      </a></li>
      <li><a href="/support.html"
          >
          Support
      </a></li>
      <li><a href="/blog"
          >
          Blog
      </a></li>
      <li><a href="http://github.com/facebook/flow">GitHub</a>
    </ul>
</nav></header>


<section class='content'><div class='width'>

<nav class='toc'>
  
    <section>
      <h3>Quick Start</h3>
      <ul>
        
          <li>
            <a href="/docs/about-flow.html#_">
              About Flow
            </a>
            
          </li>
        
          <li>
            <a href="/docs/getting-started.html#_">
              Getting started with Flow
            </a>
            
          </li>
        
          <li>
            <a href="/docs/five-simple-examples.html#_">
              Five simple examples
            </a>
            
          </li>
        
      </ul>
    </section>
  
    <section>
      <h3>User Guide</h3>
      <ul>
        
          <li>
            <a href="/docs/new-project.html#_">
              Starting a new Flow project
            </a>
            
          </li>
        
          <li>
            <a href="/docs/existing.html#_">
              Running Flow on existing code
            </a>
            
          </li>
        
          <li>
            <a href="/docs/third-party.html#_">
              Checking third-party code
            </a>
            
          </li>
        
          <li>
            <a href="/docs/running.html#_">
              Running Flow code
            </a>
            
          </li>
        
          <li>
            <a href="/docs/troubleshooting.html#_">
              Troubleshooting
            </a>
            
          </li>
        
          <li>
            <a href="/docs/cli.html#_">
              Using the CLI
            </a>
            
          </li>
        
          <li>
            <a href="/docs/advanced-configuration.html#_">
              Advanced Configuration
            </a>
            
          </li>
        
      </ul>
    </section>
  
    <section>
      <h3>Walkthroughs</h3>
      <ul>
        
          <li>
            <a href="/docs/react-example.html#_" class="active">
              A Flux & React demo
            </a>
            
          </li>
        
          <li>
            <a href="/docs/underscore.html#_">
              Flow, meet Underscore
            </a>
            
          </li>
        
      </ul>
    </section>
  
    <section>
      <h3>Language Reference</h3>
      <ul>
        
          <li>
            <a href="/docs/quick-reference.html#_">
              Quick Reference
            </a>
            
          </li>
        
          <li>
            <a href="/docs/type-annotations.html#_">
              Type Annotations
            </a>
            
          </li>
        
          <li>
            <a href="/docs/variables.html#_">
              Variables
            </a>
            
          </li>
        
          <li>
            <a href="/docs/arrays.html#_">
              Arrays and Tuples
            </a>
            
          </li>
        
          <li>
            <a href="/docs/classes.html#_">
              Classes
            </a>
            
          </li>
        
          <li>
            <a href="/docs/objects.html#_">
              Objects
            </a>
            
          </li>
        
          <li>
            <a href="/docs/functions.html#_">
              Functions
            </a>
            
          </li>
        
          <li>
            <a href="/docs/nullable-types.html#_">
              Maybe Types
            </a>
            
          </li>
        
          <li>
            <a href="/docs/destructuring.html#_">
              Destructuring
            </a>
            
          </li>
        
          <li>
            <a href="/docs/union-intersection-types.html#_">
              Union and Intersection Types
            </a>
            
          </li>
        
          <li>
            <a href="/docs/type-aliases.html#_">
              Type Aliases
            </a>
            
          </li>
        
          <li>
            <a href="/docs/typeof.html#_">
              Typeof types
            </a>
            
          </li>
        
          <li>
            <a href="/docs/operators.html#_">
              Operators
            </a>
            
          </li>
        
          <li>
            <a href="/docs/dynamic-type-tests.html#_">
              Dynamic Type Tests
            </a>
            
          </li>
        
          <li>
            <a href="/docs/primitives.html#_">
              Primitives
            </a>
            
          </li>
        
          <li>
            <a href="/docs/modules.html#_">
              Modules
            </a>
            
          </li>
        
          <li>
            <a href="/docs/declarations.html#_">
              Declarations
            </a>
            
          </li>
        
          <li>
            <a href="/docs/react.html#_">
              React
            </a>
            
          </li>
        
      </ul>
    </section>
  
</nav>


<article class='withtoc'>
    <h1>
      A Flux & React demo
      <a class="edit-page-link" href="https://github.com/facebook/flow/tree/master/website/docs/02-react-example.md" target="_blank">Edit on GitHub</a>
    </h1>
    <p></p>

    <p>For those familiar with the JavaScript library
<a href="http://facebook.github.io/react/index.html">React</a>, Flow fits quite nicely.
In this case study, we take an existing React project and attempt to have
Flow be able to successfully type check its code. While it will not be an
automatic, run the Flow type-checker only one time win, we will show that it
does not need to be painful to use Flow on your existing projects.</p>

<h2>Getting Started - Download Flux Chat</h2>

<p>In order to follow the steps below, please 
<a href="https://github.com/facebook/flux/tree/a9724ae9dedd25daa5f0127ee54343353c5cbfd6/examples/flux-chat">download Flux Chat</a>
. Flux Chat is a canonical example for the
<a href="http://facebook.github.io/flux/docs/overview.html">Flux</a>
application architecture framework built on React.</p>

<h2>Preparation</h2>

<p>Flux Chat is split over
<a href="https://github.com/facebook/flux/tree/a9724ae9dedd25daa5f0127ee54343353c5cbfd6/examples/flux-chat/js">multiple module files</a>.</p>

<h3><code>.flowconfig</code></h3>

<p>In order for Flow to be able to begin to type check these files, we must
create a <code>.flowconfig</code> file in the root directory of those files. This file
signals to the Flow type-checker where to begin type checking your code.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$&gt; </span>flow init
</code></pre></div>
<h3><code>@flow</code></h3>

<p>Next, each JavaScript implementation file in the root and below must be
<a href="https://github.com/facebook/flow/commit/d2c099065ac58fb78b5f3951d7ac912de5e5a58c">annotated with <code>@flow</code> inside the first comment block of the file</a>
. For example, in
<a href="https://github.com/facebook/flow/blob/d2c099065ac58fb78b5f3951d7ac912de5e5a58c/js/components/ChatApp.react.js"><code>js/components/ChatApp.react.js</code></a>:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15</pre></td><td class="code"><pre><span class="cm">/**
 * This file is provided by Facebook for testing and evaluation purposes
 * only. Facebook reserves all rights not expressly granted.
 *
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
 * FACEBOOK BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN
 * AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
 * CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
 *
 * @flow
 */</span>

<span class="kd">var</span> <span class="nx">MessageSection</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./MessageSection.react'</span><span class="p">);</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<blockquote>
<p>CODE CHECK</p>

<p>Here is a <a href="https://github.com/facebook/flow/commit/d2c099065ac58fb78b5f3951d7ac912de5e5a58c">diff</a> 
of the changes made in this section. </p>
</blockquote>

<h3>Flow Server</h3>

<p>After all files have been annotated with <code>@flow</code>, we are ready to start our
Flow server which watches over the now Flow-aware JavaScript files and any
changes to them. From the root directory (i.e., the one with the
<code>.flowconfig</code> file)</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$&gt; </span>flow start --lib lib
</code></pre></div>
<p>The <code>--lib</code> specifies that any <a href="declarations.html">declarations</a> that are 
needed will be placed in that directory.</p>

<h3>Type Checking</h3>

<p>Now the moment of first truth arrives. You can call <code>flow</code> to query the Flow server for any type-checking errors ... and <a href="https://gist.github.com/JoelMarcey/1629e39f3afc789b0f0e">there will be many</a>.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$&gt; </span>flow
Found 50 errors
</code></pre></div>
<blockquote>
<p>NOTE</p>

<p>Throughout this walk-through, your error list may be slightly
different than shown here.</p>
</blockquote>

<h2>Working Around Current Flow Limitations</h2>

<h3><code>object-assign</code></h3>

<p>At this stage we have already hit some limitations of Flow. Flow does not know 
about the module <code>object-assign</code>. However, it understands what <code>Object.assign</code> does. Thus, we will replace any <code>object-assign</code> usage by <code>Object.assign</code>. </p>

<p>However, since <code>Object.assign</code> may not be implemented by all JavaScript engines, we still need to &quot;polyfill&quot; it. We will do so by putting it in a file outside of Flow&#39;s knowledge (i.e., in a file <em>without</em> <code>/* @flow */</code>) like this:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">)</span> <span class="p">{</span>
  <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'object-assign'</span><span class="p">);</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h3>Class Inheritance</h3>

<p>Flow does not allow class instances to be extended at runtime. Thus, the following code will not work:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1</pre></td><td class="code"><pre><span class="kd">var</span> <span class="nx">ChatAppDispatcher</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">assign</span><span class="p">(</span><span class="k">new</span> <span class="nx">Dispatcher</span><span class="p">(),</span> <span class="cm">/*...*/</span><span class="p">);</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Instead, we need to work around this by exporting the <code>Dispatcher</code> interface 
by hand. This results in somewhat ugly code, but is the only way to get around explicit class inheritance for now. This is what it roughly looks like:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6</pre></td><td class="code"><pre><span class="kd">var</span> <span class="nx">_dispatcherInstance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Dispatcher</span><span class="p">();</span>

<span class="kd">var</span> <span class="nx">ChatAppDispatcher</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">register</span><span class="p">:</span> <span class="nx">_dispatcherInstance</span><span class="p">.</span><span class="nx">register</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="nx">_dispatcherInstance</span><span class="p">),</span>
  <span class="cm">/*...*/</span>
<span class="p">};</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<blockquote>
<p>IMPORTANT: </p>

<p>Currently there is a bug in Flow which makes it think that Object.assign 
copies all properties visible on an object, and not just own properties. 
Thus, Flow thinks that the following would extend a <code>Dispatcher</code> instance, 
even though it doesn&#39;t:</p>

<p><code>var ChatAppDispatcher = Object.assign({}, new Dispatcher(), /*...*/);</code></p>
</blockquote>

<h3>Module Files</h3>

<p>Finally regarding Flow limitations, we currently cannot create interface 
declaration files for the modules <code>react/lib/keyMirror</code> and <code>react/lib/cx</code>. 
This results in missing module errors that we need to work around. As a 
result, we disabled Flow for the files importing these two modules. While we disabled flow in these files, we did annotate and perform other Flow-aware changes so we can be error free once we do enable Flow. </p>

<blockquote>
<p>CODE CHECK</p>

<p>Here is a <a href="https://github.com/facebook/flow/commit/4a4f3aaf512eb619e5f8d9a82432b61b75710927">diff</a> 
of the changes for this section and here is the updated 
<a href="https://gist.github.com/JoelMarcey/76d1d5aaf2717ffb32f0">error output</a>.</p>
</blockquote>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$&gt; </span>flow
Found 29 errors
</code></pre></div>
<h2>Annotating Module Exports</h2>

<p>Flow requires the annotation of objects that a module exports. Forcing these
annotations allows flow to more easily check that imported modules are being
used as intended. Additionally, and possibly more importantly, is that these
annotations make both using modules and reading module code much easier.</p>

<h3>Flux-Chat Modules</h3>

<p>Now we will annotate all the modules that exist in Flux-Chat. We will ignore
cross-module and module internal errors for now. While this may seem
counter-intuitive, doing this will allow us to get a better picture of the
actual errors hidden in our project (as we will soon see).</p>

<h3>General Annotation Strategy</h3>

<p>Our first pass is to basically start annotating. We will skip those that
we are unable to annotate.</p>

<p>Modules such as <code>MessageStore.js</code> had functions that returned a message given 
a string id.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="nx">get</span><span class="err">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">_messages</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
<span class="p">},</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>What type is <code>id</code>? What exactly is a <code>message</code>? Flow helps us create higher quality code.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12</pre></td><td class="code"><pre><span class="nx">type</span> <span class="nx">Message</span> <span class="o">=</span> <span class="p">{</span>
  <span class="na">id</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nl">threadID</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nl">authorName</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nl">date</span><span class="p">:</span> <span class="nb">Date</span><span class="p">;</span>
  <span class="nl">text</span><span class="p">:</span> <span class="nx">string</span><span class="p">;</span>
  <span class="nl">isRead</span><span class="p">:</span> <span class="kr">boolean</span><span class="p">;</span>
<span class="p">};</span>
<span class="c1">// ...</span>
<span class="nl">get</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="na">id</span><span class="p">:</span> <span class="nx">string</span><span class="p">):</span> <span class="p">?</span><span class="nx">Message</span> <span class="p">{</span>
  <span class="k">return</span> <span class="nx">_messages</span><span class="p">[</span><span class="nx">id</span><span class="p">];</span>
<span class="p">},</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>After this first pass through the modules, we will go through the
modules again, taking into account the type information we learned from other
modules. Rinse and repeat this pass until we get a fully annotated interface
for all modules.</p>

<h3>Using Instances of Polymorphic Types</h3>

<p>Instances of polymorphic types can be used with arbitrary types by client 
code. Thus, if one wants to force a specific type, one needs to manually 
specify it for an instance. An example, where we need to do this is in <code>js/
dispatcher/ChatAppDispatcher.js</code>. This file exports an extended instance of 
Flux&#39;s <code>Dispatcher</code> class. We type <code>Dispatcher</code> as a polymorphic class and 
only want to allow values of specific types to be passed through it. To limit 
the payloads the dispatcher accepts we type the instance explicitly:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4</pre></td><td class="code"><pre><span class="kd">var</span> <span class="nx">_dispatcherInstance</span><span class="err">:</span> <span class="nx">Dispatcher</span><span class="o">&lt;</span><span class="nx">PayloadType</span><span class="o">&gt;</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Dispatcher</span><span class="p">();</span>

<span class="kd">var</span> <span class="nx">ChatAppDispatcher</span> <span class="o">=</span> <span class="p">{</span>
<span class="c1">// [...]</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<blockquote>
<p>NOTE</p>

<p>It is currently not possible to use syntax like 
<code>new Dispatcher&lt;PayloadType&gt;()</code>.</p>
</blockquote>

<h3>Narrowing Union Types</h3>

<p>We typed <code>ChatAppDispatcher</code>&#39;s actual payload data as a big union over different types of data. The listeners then need to decide what type the data actually is. For this, the following pattern is used:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11</pre></td><td class="code"><pre><span class="k">switch</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">type</span><span class="p">)</span> <span class="p">{</span>
<span class="k">case</span> <span class="nx">ActionTypes</span><span class="p">.</span><span class="nx">CLICK_THREAD</span><span class="err">:</span>
  <span class="c1">// Handle action as ViewClickThreadAction</span>
  <span class="k">break</span><span class="p">;</span>

<span class="k">case</span> <span class="nx">ActionTypes</span><span class="p">.</span><span class="nx">RECEIVE_RAW_MESSAGES</span><span class="err">:</span>
  <span class="c1">// Handle action as ServerReceiveRawMessagesAction</span>
  <span class="k">break</span><span class="p">;</span>

<span class="c1">// [...]</span>
<span class="p">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Ideally, we would want to narrow down the type of action inside the individual cases. However, this is currently not possible with Flow. Not all hope is lost though. Flow supports <code>any</code> as type. </p>

<blockquote>
<p>WARNING</p>

<p>Try to limit <code>any</code> use to places you hit limitations of Flow. In the latter 
case, check whether the issue is known. If it is not, we ask you to report 
it to us. Then, we can decide if and how we can improve Flow.</p>
</blockquote>

<p>This does not give us type checking guarantees on the use of action. However, it will allow you to still take advantage of Flow in the rest of your code base.</p>

<blockquote>
<p>CODE CHECK</p>

<p>Here is a <a href="https://github.com/facebook/flow/commit/c85f06b9f555cf3f95fc4d9ef0b8f683260fec40">diff</a> 
of the changes for this section and here is the updated 
<a href="https://gist.github.com/JoelMarcey/266d8696fa30268c2d04">error output</a>.</p>
</blockquote>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$&gt; </span>flow
Found 17 errors
</code></pre></div>
<h2>Tests</h2>

<p>If you now look at the current
<a href="https://gist.github.com/JoelMarcey/a41d15d5b8c72b73c23a">list of errors</a>
, you will notice some relating to our test file <code>UnreadThreadStore-test.js</code>.
For now, we are going to only weakly check the test file using <code>@flow-weak</code>.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="cm">/**
 * @flow weak
 */</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<blockquote>
<p>CODE CHECK</p>

<p>Here is a <a href="https://github.com/facebook/flow/commit/8325417064a21bd9cd819bfd0e00466df6387594">diff</a> 
of the changes for this section and here is the updated 
<a href="https://gist.github.com/JoelMarcey/81813064b07fe6892cc1">error output</a>.</p>
</blockquote>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$&gt; </span>flow
Found 8 errors
</code></pre></div>
<h2>The Real Work</h2>

<p>Until this point, we have been postponing and mitigating the errors discovered
by the Flow type-checker. Now we are at the point where we can see the real
benefits of Flow as it shows real problems with our project code.</p>

<p>We start with the low-hanging fruit and move our ways upwards until we have
no Flow errors left in our code.</p>

<h3>Missing Parameters</h3>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3</pre></td><td class="code"><pre><span class="nx">ChatWebAPIUtils</span><span class="p">.</span><span class="nx">createMessage</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
<span class="c1">// ...</span>
<span class="nl">createMessage</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="err">:</span> <span class="nx">Message</span><span class="p">,</span> <span class="nx">optThreadName</span><span class="err">:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>
<div class="highlight"><pre><code class="language-bbcode" data-lang="bbcode">js/actions/ChatMessageActionCreators.js:30:5,42: call of method createMessage
Too few arguments
  js/utils/ChatWebAPIUtils.js:40:18,61:3: function
</code></pre></div>
<p>In vanilla JavaScript, missing parameters are undefined. This can lead to
unexpected behavior or crashes. Flow will not allow code to skip parameters
unless they are specifically marked as optional with <code>?</code>. In this case, we
have one instance that requires optional.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="nx">createMessage</span><span class="err">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="err">:</span> <span class="nx">Message</span><span class="p">,</span> <span class="nx">optThreadName</span><span class="p">?:</span> <span class="nx">string</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">threadName</span> <span class="o">=</span> <span class="nx">optThreadName</span> <span class="o">||</span> <span class="s1">'New Conversation'</span><span class="p">;</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<blockquote>
<p>CODE CHECK</p>

<p>Here is a <a href="https://github.com/facebook/flow/commit/62cef6dd10be00bbb96f9cdd8ae4fb0a059e6014">diff</a> 
of the changes for this section and here is the updated 
<a href="https://gist.github.com/JoelMarcey/bd2cd831f8a593b66ddf">error output</a>.</p>
</blockquote>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$&gt; </span>flow
Found 7 errors
</code></pre></div>
<h3>Property Use</h3>

<p>Flow can also catch some React specific errors that may have been introduced.
Take the <code>MessageListItem</code> component, for example. Flow discovers the
following errors.</p>
<div class="highlight"><pre><code class="language-bbcode" data-lang="bbcode">js/components/MessageListItem.react.js:29:46,63: property authorName
This type is incompatible with
  js/components/MessageListItem.react.js:22:14,34: ?any

js/components/MessageListItem.react.js:31:12,23: property date
This type is incompatible with
  js/components/MessageListItem.react.js:22:14,34: ?any

js/components/MessageListItem.react.js:33:40,51: property text
This type is incompatible with
  js/components/MessageListItem.react.js:22:14,34: ?any
</code></pre></div>
<p>As the
<a href="https://github.com/facebook/flow/blob/flux-chat-example/js/components/MessageListItem.react.js">source of <code>MessageListItem</code></a>
shows, the <code>message</code> property is annotated through
<a href="http://facebook.github.io/react/docs/reusable-components.html">React&#39;s <code>propType</code> feature</a>
. However, it is specified as <code>message: ReactPropTypes.object</code>, which, in React
means that message is an <strong>optional</strong> property. Thus, the property might not
exist in all instances of the component. This can lead to the consequence of
undefined access. This can be seen in the Flow error output from the
question mark in <code>?any</code>. Luckily, React also allows us to specify that a
property is required and, of course, Flow understands this.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5</pre></td><td class="code"><pre><span class="nx">message</span><span class="err">:</span> <span class="nx">ReactPropTypes</span><span class="p">.</span><span class="nx">shape</span><span class="p">({</span>
  <span class="na">authorName</span><span class="p">:</span> <span class="nx">ReactPropTypes</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">isRequired</span><span class="p">,</span>
  <span class="na">date</span><span class="p">:</span> <span class="nx">ReactPropTypes</span><span class="p">.</span><span class="nx">instanceOf</span><span class="p">(</span><span class="nb">Date</span><span class="p">).</span><span class="nx">isRequired</span><span class="p">,</span>
  <span class="na">text</span><span class="p">:</span> <span class="nx">ReactPropTypes</span><span class="p">.</span><span class="nx">string</span><span class="p">.</span><span class="nx">isRequired</span>
<span class="p">}).</span><span class="nx">isRequired</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>If you are familiar with React, you might be under the impression that React
will be able to check this too. However, React does this at <em>runtime</em>, and
only in development mode. Flow will catch these errors at <em>development
time</em>.  As a result, if some client would do something like
<code>&lt;MessageListItem /&gt;</code>, Flow will discover the missing message property when checking your source. By using <code>shape</code> flow will also assure that all
properties of <code>message</code> are actually specified. Thankfully, our example
code always passed a correct message property.</p>

<p>We also adapt other components&#39; <code>propTypes</code> to property reflect the expected
types. </p>

<blockquote>
<p>CODE CHECK</p>

<p>Here is a <a href="https://github.com/facebook/flow/commit/22eb39e8bc48a598ae5518db564deb1959ed6740">diff</a> 
of the changes for this section] and here is the updated 
<a href="https://gist.github.com/JoelMarcey/591a2e4d1e7942d524c3">error output</a>.</p>
</blockquote>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$&gt; </span>flow
Found 4 errors
</code></pre></div>
<h2>Other Errors</h2>

<p>Now let&#39;s fix the other errors to make Flow happy with no errors.</p>

<h3>Property Access</h3>

<p>In <code>ThreadsStore.js</code>,</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">thread</span> <span class="o">&amp;&amp;</span> <span class="nx">thread</span><span class="p">.</span><span class="nx">lastTimestamp</span> <span class="o">&gt;</span> <span class="nx">message</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">// ...</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>
<div class="highlight"><pre><code class="language-bbcode" data-lang="bbcode">js/stores/ThreadStore.js:62:21,40: property lastTimestamp
Property lastTimestamp not found in object:
  js/stores/ThreadStore.js:38:15,42:1: object type
</code></pre></div>
<p>We have code that tries to access a property which does not exist in a given
object. We fix this by using an existing property instead.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="k">if</span> <span class="p">(</span><span class="nx">thread</span> <span class="o">&amp;&amp;</span> <span class="nx">thread</span><span class="p">.</span><span class="nx">lastMessage</span><span class="p">.</span><span class="nx">date</span><span class="p">.</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">&gt;</span> <span class="nx">message</span><span class="p">.</span><span class="nx">timestamp</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">// ...</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h3>Null Variable</h3>

<p>In <code>MessageSection.js</code>,</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre> <span class="o">&lt;</span><span class="nx">h3</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"message-thread-heading"</span><span class="o">&gt;</span><span class="p">{</span><span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">thread</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/h3</span><span class="err">&gt;
</span><span class="c1">// ...</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>
<div class="highlight"><pre><code class="language-bbcode" data-lang="bbcode">js/components/MessageSection.react.js:78:49,70: property name
This type is incompatible with
  js/components/MessageSection.react.js:38:12,17: ?Thread
</code></pre></div>
<p>Here we try to access a variable that could possibly be <code>null</code>. In this case,
you check for the variable being <code>null</code> and add special handling for that case.</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre><span class="nx">render</span><span class="err">:</span> <span class="kd">function</span><span class="p">()</span><span class="err">:</span> <span class="nx">any</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">thread</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">thread</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">name</span> <span class="o">=</span> <span class="nx">thread</span> <span class="p">?</span> <span class="nx">thread</span><span class="p">.</span><span class="nx">name</span> <span class="p">:</span> <span class="s2">""</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">messageListItems</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">state</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">getMessageListItem</span><span class="p">);</span>
  <span class="k">return</span> <span class="p">(</span>
    <span class="o">&lt;</span><span class="nx">div</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"message-section"</span><span class="o">&gt;</span>
    <span class="o">&lt;</span><span class="nx">h3</span> <span class="nx">className</span><span class="o">=</span><span class="s2">"message-thread-heading"</span><span class="o">&gt;</span><span class="p">{</span><span class="nx">name</span><span class="p">}</span><span class="o">&lt;</span><span class="sr">/h3</span><span class="err">&gt;
</span><span class="c1">// ...</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<h3>The Final Two Errors</h3>

<blockquote>
<p>NOTE</p>

<p>These errors may not be in your list of errors depending on how you
annotated the code above, but just in case, this is how these type of
errors can be resolved.</p>
</blockquote>

<p>Here are the final two errors:</p>
<div class="highlight"><pre><code class="language-bbcode" data-lang="bbcode">js/stores/MessageStore.js:38:14,19: ?string
This type is incompatible with
  js/stores/MessageStore.js:23:13,18: string

js/stores/ThreadStore.js:126:30,35: ?string
This type is incompatible with
  js/stores/MessageStore.js:23:13,18: string
</code></pre></div>
<p>These errors come from the following piece of code:</p>

<figure class="highlight"><pre><code class="language-javascript" data-lang="javascript"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2</pre></td><td class="code"><pre><span class="kd">var</span> <span class="nx">message</span> <span class="o">=</span> <span class="nx">MessageStore</span><span class="p">.</span><span class="nx">getCreatedMessageData</span><span class="p">(</span><span class="nx">action</span><span class="p">.</span><span class="nx">text</span><span class="p">);</span>
<span class="nx">_messages</span><span class="p">[</span><span class="nx">message</span><span class="p">.</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">message</span><span class="p">;</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Here two different types come together. Investigation of this error shows
that it results from a bigger design issue in the implementation of flux-chat.
However, there is no way to actually make the code produce <code>null</code> at runtime
right now. Thus, we will take an escape hatch and make Flow not complain about
it anymore. We do this by simply annotating message with the type <code>any</code>. Flow
will then assume <code>message</code> can be assigned to any type.</p>

<blockquote>
<p>CODE CHECK</p>

<p>Here is a <a href="https://github.com/facebook/flow/commit/564b2dd26d71c7cd300052fb831e0104e24b5292">diff</a> 
of the changes for this section.</p>
</blockquote>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$&gt; </span>flow
Found 4 errors
</code></pre></div>
<h2>No Errors!</h2>

<p>If all went according to plan,
<a href="https://gist.github.com/JoelMarcey/30145418434c0b0a25ea">this</a>
is what you should see when running <code>flow</code> for the final time.</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash"><span class="gp">$&gt; </span>flow
No errors!
</code></pre></div>
<h2>Stripping Annotations</h2>

<p>Finally, we need to adapt the building process to strip type annotations.
For this we need to update the <code>reactify</code> dependency in <code>package.json</code> to 
0.17.0. Starting from this version <code>reactify</code> allows to strip type 
annotations. The changes needed are trivial. We only need to set the 
<code>stripTypes</code> to <code>true</code>. Afterwards, we do the following to start the automated 
building process:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">npm install
npm start
</code></pre></div>
<p>Now we can start a http server and check our results in the browser:</p>
<div class="highlight"><pre><code class="language-bash" data-lang="bash">python -m SimpleHTTPServer
</code></pre></div>
<p>and then navigate to <code>localhost:8000</code>.</p>

<blockquote>
<p>CODE CHECK</p>

<p>Here is a <a href="https://github.com/facebook/flow/commit/8e19ceca38e96cff3b372347e1c356c09fd02b7c">diff</a> 
of the changes for this section.</p>
</blockquote>


    <div class="docs-prevnext">
      
        <a href="/docs/advanced-configuration.html#_">&larr; Prev</a>
      
      
        <a class="right" href="/docs/underscore.html#_">Next &rarr;</a>
      
    </div>

    <a id="_"></a>
</article>

</div></section>
<footer><div class='width'>
    &copy; Copyright 2014 - 2016, Facebook Inc.
</div></footer>

<script src="/static/linkify.js"></script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
   (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-387204-12', 'facebook.github.io');
  ga('send', 'pageview');

  !function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="https://platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");
</script>
</body>
</html>

